name: CI

on:
  push:
    branches: [ main, develop, 'cma/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_BUILDKIT: 1

jobs:
  # Job unique : Le Dockerfile fait TOUT (fmt, clippy, test, build)
  docker-ci:
    name: Docker CI
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Build stage builder : fait fmt + clippy + test + build
      # Si une étape échoue, le build échoue = CI rouge
      - name: Build and test (builder stage does everything)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/ci.Dockerfile
          target: builder
          push: false
          tags: cma-rust-builder:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Extraire les binaires directement du stage builder
      - name: Extract binaries from builder stage
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/ci.Dockerfile
          target: builder
          outputs: type=local,dest=./artifacts
          cache-from: type=gha
      
      - name: List extracted files
        run: |
          echo "📦 Binaires extraits du stage builder:"
          find artifacts -name "loggerd" -o -name "waydash" -o -name "traces"
          mkdir -p binaries
          find artifacts/build/target/release -maxdepth 1 -type f -executable -exec cp {} binaries/ \;
          ls -lh binaries/
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: binaries-x86_64
          path: binaries/*
          retention-days: 30
      
      # Build images runtime (optionnel, si vous voulez les images Docker)
      - name: Build loggerd runtime image
        if: success()
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/ci.Dockerfile
          target: loggerd-runtime
          push: false
          tags: cma-rust-loggerd:${{ github.sha }}
          cache-from: type=gha
      
      - name: Build waydash runtime image
        if: success()
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/ci.Dockerfile
          target: waydash-runtime
          push: false
          tags: cma-rust-waydash:${{ github.sha }}
          cache-from: type=gha
      
      - name: Summary
        if: always()
        run: |
          echo "## 🐳 CI Docker Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Le \`ci.Dockerfile\` a exécuté automatiquement :" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ \`cargo fmt --check\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ \`cargo clippy -- -D warnings\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ \`cargo test --all\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ \`cargo build --release\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images générées :" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 \`cma-rust-loggerd:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 \`cma-rust-waydash:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
